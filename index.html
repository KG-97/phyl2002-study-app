<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PHYL2002 Study Package</title>
    <style>
      :root {
        /* Primitive Color Tokens */
        --color-white: rgba(255, 255, 255, 1);
        --color-black: rgba(0, 0, 0, 1);
        --color-cream-50: rgba(252, 252, 249, 1);
        --color-cream-100: rgba(255, 255, 253, 1);
        --color-gray-200: rgba(245, 245, 245, 1);
        --color-gray-300: rgba(167, 169, 169, 1);
        --color-gray-400: rgba(119, 124, 124, 1);
        --color-slate-500: rgba(98, 108, 113, 1);
        --color-brown-600: rgba(94, 82, 64, 1);
        --color-charcoal-700: rgba(31, 33, 33, 1);
        --color-charcoal-800: rgba(38, 40, 40, 1);
        --color-slate-900: rgba(19, 52, 59, 1);
        --color-teal-300: rgba(50, 184, 198, 1);
        --color-teal-400: rgba(45, 166, 178, 1);
        --color-teal-500: rgba(33, 128, 141, 1);
        --color-teal-600: rgba(29, 116, 128, 1);
        --color-teal-700: rgba(26, 104, 115, 1);
        --color-teal-800: rgba(41, 150, 161, 1);
        --color-red-400: rgba(255, 84, 89, 1);
        --color-red-500: rgba(192, 21, 47, 1);
        --color-orange-400: rgba(230, 129, 97, 1);
        --color-orange-500: rgba(168, 75, 47, 1);

        /* RGB versions for opacity control */
        --color-brown-600-rgb: 94, 82, 64;
        --color-teal-500-rgb: 33, 128, 141;
        --color-slate-900-rgb: 19, 52, 59;
        --color-slate-500-rgb: 98, 108, 113;
        --color-red-500-rgb: 192, 21, 47;
        --color-red-400-rgb: 255, 84, 89;
        --color-orange-500-rgb: 168, 75, 47;
        --color-orange-400-rgb: 230, 129, 97;

        /* Semantic Color Tokens (Light Mode) */
        --color-background: var(--color-cream-50);
        --color-surface: var(--color-cream-100);
        --color-text: var(--color-slate-900);
        --color-text-secondary: var(--color-slate-500);
        --color-primary: var(--color-teal-500);
        --color-primary-hover: var(--color-teal-600);
        --color-primary-active: var(--color-teal-700);
        --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
        --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
        --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
        --color-border: rgba(var(--color-brown-600-rgb), 0.2);
        --color-btn-primary-text: var(--color-cream-50);
        --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
        --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
        --color-error: var(--color-red-500);
        --color-success: var(--color-teal-500);
        --color-warning: var(--color-orange-500);
        --color-info: var(--color-slate-500);
        --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

        /* System colors - Light */
        --color-neural: #3B82F6;
        --color-neural-light: rgba(59, 130, 246, 0.1);
        --color-muscle: #EF4444;
        --color-muscle-light: rgba(239, 68, 68, 0.1);
        --color-sensory: #22C55E;
        --color-sensory-light: rgba(34, 197, 94, 0.1);
        --color-success-light: rgba(34, 197, 94, 0.1);
        --color-warning-light: rgba(245, 158, 11, 0.1);

        /* RGB versions for status indicators */
        --color-success-rgb: 33, 128, 141;
        --color-error-rgb: 192, 21, 47;
        --color-warning-rgb: 168, 75, 47;
        --color-info-rgb: 98, 108, 113;

        /* Typography */
        --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
          BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
          Monaco, Consolas, monospace;
        --font-size-xs: 11px;
        --font-size-sm: 12px;
        --font-size-base: 14px;
        --font-size-md: 14px;
        --font-size-lg: 16px;
        --font-size-xl: 18px;
        --font-size-2xl: 20px;
        --font-size-3xl: 24px;
        --font-size-4xl: 30px;
        --font-weight-normal: 400;
        --font-weight-medium: 500;
        --font-weight-semibold: 550;
        --font-weight-bold: 600;

        /* Spacing */
        --space-4: 4px;
        --space-8: 8px;
        --space-12: 12px;
        --space-16: 16px;
        --space-20: 20px;
        --space-24: 24px;
        --space-32: 32px;

        /* Border Radius */
        --radius-sm: 6px;
        --radius-base: 8px;
        --radius-lg: 12px;
        --radius-full: 9999px;

        /* Shadows */
        --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
          0 2px 4px -1px rgba(0, 0, 0, 0.02);

        /* Animation */
        --duration-fast: 150ms;
        --duration-normal: 250ms;
        --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
      }

      /* Dark mode colors */
      @media (prefers-color-scheme: dark) {
        :root {
          --color-background: var(--color-charcoal-700);
          --color-surface: var(--color-charcoal-800);
          --color-text: var(--color-gray-200);
          --color-text-secondary: rgba(167, 169, 169, 0.7);
          --color-primary: var(--color-teal-300);
          --color-primary-hover: var(--color-teal-400);
          --color-primary-active: var(--color-teal-800);
          --color-secondary: rgba(119, 124, 124, 0.15);
          --color-secondary-hover: rgba(119, 124, 124, 0.25);
          --color-secondary-active: rgba(119, 124, 124, 0.3);
          --color-border: rgba(119, 124, 124, 0.3);
          --color-error: var(--color-red-400);
          --color-success: var(--color-teal-300);
          --color-warning: var(--color-orange-400);
          --color-info: var(--color-gray-300);
          --color-focus-ring: rgba(50, 184, 198, 0.4);
          --color-btn-primary-text: var(--color-slate-900);
          --color-card-border: rgba(119, 124, 124, 0.2);
          --color-card-border-inner: rgba(119, 124, 124, 0.15);

          /* System colors - Dark */
          --color-neural: #60A5FA;
          --color-neural-light: rgba(59, 130, 246, 0.15);
          --color-muscle: #F87171;
          --color-muscle-light: rgba(239, 68, 68, 0.15);
          --color-sensory: #4ADE80;
          --color-sensory-light: rgba(34, 197, 94, 0.15);
          --color-success-light: rgba(74, 222, 128, 0.15);
          --color-warning-light: rgba(251, 191, 36, 0.15);

          /* RGB versions for status indicators - Dark */
          --color-success-rgb: 50, 184, 198;
          --color-error-rgb: 255, 84, 89;
          --color-warning-rgb: 230, 129, 97;
          --color-info-rgb: 167, 169, 169;
        }
      }

      /* Data attribute for manual theme switching */
      [data-theme="dark"] {
        --color-background: var(--color-charcoal-700);
        --color-surface: var(--color-charcoal-800);
        --color-text: var(--color-gray-200);
        --color-text-secondary: rgba(167, 169, 169, 0.7);
        --color-primary: var(--color-teal-300);
        --color-primary-hover: var(--color-teal-400);
        --color-primary-active: var(--color-teal-800);
        --color-secondary: rgba(119, 124, 124, 0.15);
        --color-secondary-hover: rgba(119, 124, 124, 0.25);
        --color-secondary-active: rgba(119, 124, 124, 0.3);
        --color-border: rgba(119, 124, 124, 0.3);
        --color-error: var(--color-red-400);
        --color-success: var(--color-teal-300);
        --color-warning: var(--color-orange-400);
        --color-info: var(--color-gray-300);
        --color-focus-ring: rgba(50, 184, 198, 0.4);
        --color-btn-primary-text: var(--color-slate-900);
        --color-card-border: rgba(119, 124, 124, 0.2);
        --color-card-border-inner: rgba(119, 124, 124, 0.15);

        /* System colors - Dark */
        --color-neural: #60A5FA;
        --color-neural-light: rgba(59, 130, 246, 0.15);
        --color-muscle: #F87171;
        --color-muscle-light: rgba(239, 68, 68, 0.15);
        --color-sensory: #4ADE80;
        --color-sensory-light: rgba(34, 197, 94, 0.15);
        --color-success-light: rgba(74, 222, 128, 0.15);
        --color-warning-light: rgba(251, 191, 36, 0.15);

        /* RGB versions for status indicators - Dark */
        --color-success-rgb: 50, 184, 198;
        --color-error-rgb: 255, 84, 89;
        --color-warning-rgb: 230, 129, 97;
        --color-info-rgb: 167, 169, 169;
      }

      [data-theme="light"] {
        --color-background: var(--color-cream-50);
        --color-surface: var(--color-cream-100);
        --color-text: var(--color-slate-900);
        --color-text-secondary: var(--color-slate-500);
        --color-primary: var(--color-teal-500);
        --color-primary-hover: var(--color-teal-600);
        --color-primary-active: var(--color-teal-700);
        --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
        --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
        --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
        --color-border: rgba(var(--color-brown-600-rgb), 0.2);
        --color-btn-primary-text: var(--color-cream-50);
        --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
        --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
        --color-error: var(--color-red-500);
        --color-success: var(--color-teal-500);
        --color-warning: var(--color-orange-500);
        --color-info: var(--color-slate-500);
        --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);

        /* System colors - Light */
        --color-neural: #3B82F6;
        --color-neural-light: rgba(59, 130, 246, 0.1);
        --color-muscle: #EF4444;
        --color-muscle-light: rgba(239, 68, 68, 0.1);
        --color-sensory: #22C55E;
        --color-sensory-light: rgba(34, 197, 94, 0.1);
        --color-success-light: rgba(34, 197, 94, 0.1);
        --color-warning-light: rgba(245, 158, 11, 0.1);

        /* RGB versions for status indicators - Light */
        --color-success-rgb: 33, 128, 141;
        --color-error-rgb: 192, 21, 47;
        --color-warning-rgb: 168, 75, 47;
        --color-info-rgb: 98, 108, 113;
      }

      /* Base styles */
      @font-face {
        font-family: 'FKGroteskNeue';
        src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2') format('woff2');
      }

      html {
        font-family: var(--font-family-base);
        color: var(--color-text);
        background-color: var(--color-background);
        -webkit-font-smoothing: antialiased;
        box-sizing: border-box;
      }

      body {
        margin: 0;
        padding: 0;
        transition: background-color var(--duration-normal), color var(--duration-normal);
      }

      *, *::before, *::after {
        box-sizing: inherit;
      }

      h2 { font-size: var(--font-size-3xl); }
      h3 { font-size: var(--font-size-2xl); }
      h4 { font-size: var(--font-size-lg); }

      /* Navigation */
      .nav-bar {
        background: var(--color-surface);
        border-bottom: 1px solid var(--color-border);
        padding: var(--space-16) 0;
        position: sticky;
        top: 0;
        z-index: 100;
        box-shadow: var(--shadow-sm);
      }

      .nav-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 var(--space-16);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .nav-title {
        margin: 0;
        font-size: var(--font-size-2xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary);
      }

      .nav-controls {
        display: flex;
        align-items: center;
        gap: var(--space-24);
      }

      .nav-tabs {
        display: flex;
        gap: var(--space-4);
      }

      .nav-tab {
        padding: var(--space-8) var(--space-16);
        background: none;
        border: none;
        border-radius: var(--radius-base);
        cursor: pointer;
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-medium);
        color: var(--color-text-secondary);
        transition: all var(--duration-fast);
      }

      .nav-tab:hover {
        background: var(--color-secondary);
        color: var(--color-text);
      }

      .nav-tab.active {
        background: var(--color-primary);
        color: var(--color-btn-primary-text);
        font-weight: var(--font-weight-semibold);
      }

      /* Main Content */
      .main-content {
        max-width: 1200px;
        margin: 0 auto;
        padding: var(--space-24) var(--space-16);
      }

      .section {
        display: none;
        animation: fadeIn var(--duration-normal) ease-in-out;
      }

      .section.active {
        display: block;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Dashboard */
      .dashboard-header {
        text-align: center;
        margin-bottom: var(--space-32);
      }

      .progress-summary {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: var(--space-12);
      }

      .progress-item {
        display: flex;
        align-items: center;
        gap: var(--space-12);
      }

      .progress-bar {
        width: 200px;
        height: 8px;
        background: var(--color-secondary);
        border-radius: var(--radius-full);
        overflow: hidden;
      }

      .progress-fill {
        height: 100%;
        background: var(--color-primary);
        transition: width var(--duration-normal);
        width: 0%;
      }

      .progress-text {
        font-weight: var(--font-weight-bold);
        color: var(--color-primary);
      }

      .concept-map-section {
        text-align: center;
        margin-bottom: var(--space-32);
      }

      .concept-map {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-md);
      }

      /* Lecture Categories */
      .category-section {
        margin-bottom: var(--space-32);
        padding: var(--space-24);
        border-radius: var(--radius-lg);
        border: 2px solid;
      }

      .category-section.neural {
        border-color: var(--color-neural);
        background: var(--color-neural-light);
      }
      .category-section.muscle {
        border-color: var(--color-muscle);
        background: var(--color-muscle-light);
      }
      .category-section.sensory {
        border-color: var(--color-sensory);
        background: var(--color-sensory-light);
      }

      .category-section h3 {
        margin-bottom: var(--space-16);
        font-size: var(--font-size-2xl);
        text-align: center;
      }

      .neural h3 { color: var(--color-neural); }
      .muscle h3 { color: var(--color-muscle); }
      .sensory h3 { color: var(--color-sensory); }

      .lecture-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--space-16);
      }

      .lecture-card {
        background: var(--color-surface);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-lg);
        padding: var(--space-16);
        cursor: pointer;
        transition: all var(--duration-fast);
        position: relative;
      }

      .lecture-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-md);
      }

      .lecture-status {
        position: absolute;
        top: var(--space-8);
        right: var(--space-8);
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--color-secondary);
      }

      .lecture-status.completed {
        background: var(--color-success);
      }

      /* Quick References */
      .reference-tabs {
        display: flex;
        gap: var(--space-4);
        margin-bottom: var(--space-24);
        border-bottom: 1px solid var(--color-border);
      }

      .ref-tab {
        padding: var(--space-12) var(--space-16);
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-size: var(--font-size-base);
        font-weight: var(--font-weight-medium);
        color: var(--color-text-secondary);
        transition: all var(--duration-fast);
      }

      .ref-tab:hover {
        color: var(--color-text);
      }

      .ref-tab.active {
        color: var(--color-primary);
        border-bottom-color: var(--color-primary);
      }

      .reference-table { display: none; }
      .reference-table.active { display: block; }

      .reference-chart {
        max-width: 100%;
        height: auto;
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-sm);
      }

      .table-container {
        overflow-x: auto;
        border-radius: var(--radius-lg);
        border: 1px solid var(--color-border);
      }

      .data-table {
        width: 100%;
        border-collapse: collapse;
        background: var(--color-surface);
      }

      .data-table th, .data-table td {
        padding: var(--space-12);
        text-align: left;
        border-bottom: 1px solid var(--color-border);
      }

      .data-table th {
        background: var(--color-secondary);
        font-weight: var(--font-weight-semibold);
      }

      .neurotransmitter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-16);
      }

      .nt-card {
        background: var(--color-surface);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-lg);
        padding: var(--space-16);
        box-shadow: var(--shadow-sm);
      }

      .nt-card h4 {
        margin-bottom: var(--space-12);
        color: var(--color-primary);
      }

      /* Practice Questions */
      .practice-controls {
        display: flex;
        gap: var(--space-16);
        margin-bottom: var(--space-24);
        align-items: center;
      }

      #topic-filter {
        padding: var(--space-8) var(--space-12);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-base);
        background: var(--color-surface);
        color: var(--color-text);
        min-width: 200px;
      }

      .quiz-container {
        background: var(--color-surface);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-lg);
        padding: var(--space-24);
        margin-bottom: var(--space-24);
      }

      .question-card {
        margin-bottom: var(--space-24);
      }

      .question-text {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-medium);
        margin-bottom: var(--space-16);
      }

      .option-list {
        list-style: none;
        padding: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: var(--space-8);
      }

      .option-button {
        width: 100%;
        padding: var(--space-12);
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-base);
        cursor: pointer;
        text-align: left;
        transition: all var(--duration-fast);
      }

      .option-button:hover:not(:disabled) {
        background: var(--color-secondary);
        border-color: var(--color-primary);
      }

      .option-button.selected {
        background: var(--color-primary);
        color: var(--color-btn-primary-text);
        border-color: var(--color-primary);
      }

      .option-button.correct {
        background-color: var(--color-success) !important;
        color: var(--color-btn-primary-text) !important;
        border-color: var(--color-success) !important;
      }

      .option-button.incorrect {
        background-color: var(--color-error) !important;
        color: var(--color-btn-primary-text) !important;
        border-color: var(--color-error) !important;
      }

      .explanation {
        background: var(--color-secondary);
        padding: var(--space-12);
        border-radius: var(--radius-base);
        margin-top: var(--space-16);
        border-left: 4px solid var(--color-primary);
      }

      .quiz-results {
        background: var(--color-surface);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-lg);
        padding: var(--space-24);
        text-align: center;
      }

      .results-score {
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary);
        margin-bottom: var(--space-16);
      }

      .results-actions {
        display: flex;
        justify-content: center;
        gap: var(--space-12);
        margin-top: var(--space-16);
      }

      /* AI Lab */
      .ai-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-16);
        margin-top: var(--space-16);
      }

      .ai-card {
        background: var(--color-surface);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-lg);
        padding: var(--space-20);
        box-shadow: var(--shadow-sm);
      }

      .ai-card h3 {
        margin-top: 0;
        display: flex;
        align-items: center;
        gap: var(--space-8);
      }

      .badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: var(--radius-full);
        background: var(--color-secondary);
        color: var(--color-text);
        font-weight: var(--font-weight-medium);
        font-size: var(--font-size-sm);
      }

      .provider-select {
        width: 100%;
        padding: var(--space-8);
        border-radius: var(--radius-base);
        border: 1px solid var(--color-border);
        background: var(--color-background);
        color: var(--color-text);
      }

      .ai-log {
        max-height: 260px;
        overflow-y: auto;
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-base);
        padding: var(--space-12);
        background: var(--color-secondary);
        margin-bottom: var(--space-12);
      }

      .ai-message {
        margin-bottom: var(--space-12);
        padding: var(--space-8);
        border-radius: var(--radius-base);
        background: var(--color-surface);
        border: 1px solid var(--color-card-border-inner);
      }

      .ai-message.user {
        border-left: 4px solid var(--color-primary);
      }

      .ai-message.ai {
        border-left: 4px solid var(--color-warning);
      }

      .ai-input {
        width: 100%;
        min-height: 80px;
        padding: var(--space-12);
        border-radius: var(--radius-base);
        border: 1px solid var(--color-border);
        background: var(--color-background);
        color: var(--color-text);
        font-family: var(--font-family-base);
      }

      .flashcard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: var(--space-12);
        margin-top: var(--space-12);
      }

      .flashcard {
        background: var(--color-surface);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-lg);
        padding: var(--space-12);
        box-shadow: var(--shadow-sm);
      }

      .flashcard h4 {
        margin-top: 0;
        color: var(--color-primary);
      }

      .adaptive-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: var(--space-12);
        margin-top: var(--space-8);
      }

      /* Exam Checklist */
      .checklist-progress {
        background: var(--color-surface);
        border: 1px solid var(--color-card-border);
        border-radius: var(--radius-lg);
        padding: var(--space-24);
        margin-bottom: var(--space-32);
      }

      .progress-stats {
        display: flex;
        justify-content: center;
        gap: var(--space-32);
      }

      .stat-number {
        display: block;
        font-size: var(--font-size-3xl);
        font-weight: var(--font-weight-bold);
        color: var(--color-primary);
      }

      .checklist-category {
        margin-bottom: var(--space-32);
        padding: var(--space-20);
        border-radius: var(--radius-lg);
        border: 2px solid;
      }

      .checklist-items {
        display: grid;
        gap: var(--space-8);
      }

      .checklist-item {
        display: flex;
        align-items: center;
        gap: var(--space-12);
        padding: var(--space-12);
        background: var(--color-surface);
        border-radius: var(--radius-base);
        border: 1px solid var(--color-card-border);
        transition: all var(--duration-fast);
        cursor: pointer;
      }

      .checklist-item:hover {
        background: var(--color-secondary);
      }

      .checklist-item.completed {
        background: var(--color-success-light);
        border-color: var(--color-success);
      }

      .checklist-checkbox {
        width: 20px;
        height: 20px;
        border: 2px solid var(--color-border);
        border-radius: var(--radius-sm);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--color-surface);
        transition: all var(--duration-fast);
        flex-shrink: 0;
      }

      .checklist-checkbox.checked {
        background: var(--color-success);
        border-color: var(--color-success);
        color: white;
      }

      .checklist-item.completed .checklist-text {
        color: var(--color-text-secondary);
        text-decoration: line-through;
      }

      /* Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        backdrop-filter: blur(4px);
        animation: fadeIn 0.2s ease-out;
      }

      .modal.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .modal-content {
        background-color: var(--color-surface);
        padding: var(--space-24);
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 800px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        box-shadow: var(--shadow-md);
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from { transform: translateY(-20px) scale(0.98); opacity: 0; }
        to { transform: translateY(0) scale(1); opacity: 1; }
      }

      .close {
        color: var(--color-text-secondary);
        position: absolute;
        top: var(--space-12);
        right: var(--space-16);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover {
        color: var(--color-text);
      }

      .modal-title {
        margin-bottom: var(--space-16);
        font-size: var(--font-size-2xl);
        color: var(--color-primary);
      }
      
      .modal-section {
          margin-bottom: var(--space-24);
      }

      .modal-section h4 {
        margin-bottom: var(--space-12);
        border-bottom: 1px solid var(--color-border);
        padding-bottom: var(--space-4);
      }

      .objective-list,
      .mechanism-list {
          list-style: none;
          padding-left: var(--space-24);
      }

      .objective-list li,
      .mechanism-list li {
          position: relative;
          margin-bottom: var(--space-8);
      }

      .objective-list li::before {
        content: "üéØ";
        position: absolute;
        left: -24px;
      }

      .mechanism-list li::before {
        content: "‚öôÔ∏è";
        position: absolute;
        left: -24px;
      }

      .clinical-box {
        background: var(--color-warning-light);
        padding: var(--space-16);
        border-radius: var(--radius-base);
        border-left: 4px solid var(--color-warning);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: var(--space-8) var(--space-16);
        border-radius: var(--radius-base);
        font-size: var(--font-size-base);
        font-weight: 500;
        cursor: pointer;
        transition: all var(--duration-normal) var(--ease-standard);
        border: none;
      }

      .btn--primary {
        background: var(--color-primary);
        color: var(--color-btn-primary-text);
      }
      .btn--primary:hover {
        background: var(--color-primary-hover);
      }

      .btn--secondary {
        background: var(--color-secondary);
        color: var(--color-text);
      }
      .btn--secondary:hover {
        background: var(--color-secondary-hover);
      }

      .btn--sm {
        padding: var(--space-4) var(--space-12);
        font-size: var(--font-size-sm);
        border-radius: var(--radius-sm);
      }

      /* Footer */
      .footer {
        text-align: center;
        padding: var(--space-24) var(--space-16);
        margin-top: var(--space-32);
        border-top: 1px solid var(--color-border);
        color: var(--color-text-secondary);
        font-size: var(--font-size-sm);
      }

      /* Utilities */
      .hidden { display: none !important; }
      .text-center { text-align: center; }

      /* Responsive */
      @media (max-width: 768px) {
        .nav-container, .nav-controls {
          flex-direction: column;
          gap: var(--space-16);
        }
        
        .progress-stats {
          flex-direction: column;
          gap: var(--space-16);
        }
        
        .lecture-grid {
          grid-template-columns: 1fr;
        }
        
        .practice-controls {
          flex-direction: column;
          align-items: stretch;
        }
      }
    </style>
</head>
<body>
    <nav class="nav-bar" role="navigation" aria-label="Main Navigation">
        <div class="nav-container">
            <h1 class="nav-title">PHYL2002 Study Package</h1>
            <div class="nav-controls">
                <div class="nav-tabs" role="tablist">
                    <button id="tab-dashboard" class="nav-tab active" role="tab" aria-selected="true" aria-controls="dashboard" data-section="dashboard">Dashboard</button>
                    <button id="tab-references" class="nav-tab" role="tab" aria-selected="false" aria-controls="references" data-section="references">Quick Reference</button>
                    <button id="tab-practice" class="nav-tab" role="tab" aria-selected="false" aria-controls="practice" data-section="practice">Practice Questions</button>
                    <button id="tab-ai" class="nav-tab" role="tab" aria-selected="false" aria-controls="ai-lab" data-section="ai-lab">AI Lab</button>
                    <button id="tab-checklist" class="nav-tab" role="tab" aria-selected="false" aria-controls="checklist" data-section="checklist">Exam Checklist</button>
                </div>
                <button id="theme-toggle" class="btn btn--secondary btn--sm" aria-label="Toggle theme">Toggle Theme</button>
                <button id="reset-progress-btn" class="btn btn--secondary btn--sm" aria-label="Reset progress">Reset Progress</button>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <!-- Dashboard Section -->
        <section id="dashboard" class="section active" role="tabpanel" aria-labelledby="tab-dashboard">
            <div class="container">
                <div class="dashboard-header">
                    <h2>Cellular Physiology Course Overview</h2>
                    <div class="progress-summary">
                        <div class="progress-item">
                            <span class="progress-label">Overall Progress</span>
                            <div class="progress-bar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-fill" id="overall-progress"></div>
                            </div>
                            <span class="progress-text" id="progress-text">0%</span>
                        </div>
                    </div>
                </div>

                <div class="concept-map-section">
                    <h3>Course Concept Map</h3>
                    <img src="phyl2002_concept_map.png" alt="PHYL2002 Concept Map" class="concept-map" onerror="this.style.display='none'">
                </div>

                <div class="lecture-categories">
                    <div class="category-section neural">
                        <h3>Neural Function</h3>
                        <div class="lecture-grid" id="neural-lectures"></div>
                    </div>
                    
                    <div class="category-section muscle">
                        <h3>Muscle Physiology</h3>
                        <div class="lecture-grid" id="muscle-lectures"></div>
                    </div>
                    
                    <div class="category-section sensory">
                        <h3>Sensory Systems</h3>
                        <div class="lecture-grid" id="sensory-lectures"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quick References Section -->
        <section id="references" class="section" role="tabpanel" aria-labelledby="tab-references">
            <div class="container">
                <h2>Quick Reference Tables</h2>
                <div class="reference-tabs" role="tablist">
                    <button class="ref-tab active" role="tab" aria-selected="true" aria-controls="ion-channels" data-ref="ion-channels">Ion Channels</button>
                    <button class="ref-tab" role="tab" aria-selected="false" aria-controls="muscle-comparison" data-ref="muscle-comparison">Muscle Types</button>
                    <button class="ref-tab" role="tab" aria-selected="false" aria-controls="sensory-systems" data-ref="sensory-systems">Sensory Systems</button>
                    <button class="ref-tab" role="tab" aria-selected="false" aria-controls="neurotransmitters" data-ref="neurotransmitters">Neurotransmitters</button>
                </div>
                
                <div class="reference-content">
                    <div id="ion-channels" class="reference-table active" role="tabpanel" aria-labelledby="ion-channels-tab">
                        <h3>Ion Channel Types &amp; Properties</h3>
                        <div class="table-container" id="ion-channel-table"></div>
                    </div>
                    
                    <div id="muscle-comparison" class="reference-table" role="tabpanel" aria-labelledby="muscle-comparison-tab">
                        <h3>Muscle Type Comparison</h3>
                        <img src="muscle_comparison.png" alt="Muscle Comparison Chart" class="reference-chart" onerror="this.style.display='none'">
                    </div>
                    
                    <div id="sensory-systems" class="reference-table" role="tabpanel" aria-labelledby="sensory-systems-tab">
                        <h3>Sensory Systems Overview</h3>
                        <img src="sensory_systems_chart.png" alt="Sensory Systems Chart" class="reference-chart" onerror="this.style.display='none'">
                    </div>
                    
                    <div id="neurotransmitters" class="reference-table" role="tabpanel" aria-labelledby="neurotransmitters-tab">
                        <h3>Key Neurotransmitters</h3>
                        <div class="neurotransmitter-grid" id="neurotransmitter-grid">
                            <!-- Neurotransmitter cards will be dynamically inserted here -->
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Practice Questions Section -->
        <section id="practice" class="section" role="tabpanel" aria-labelledby="tab-practice">
            <div class="container">
                <h2>Practice Questions</h2>
                <div class="practice-controls">
                    <label for="topic-filter" class="sr-only">Filter by topic</label>
                    <select id="topic-filter">
                        <!-- Options will be dynamically inserted here -->
                    </select>
                    <div class="badge" id="adaptive-status" aria-live="polite">AI difficulty: medium</div>
                    <button id="start-quiz-btn" class="btn btn--primary" aria-label="Start quiz">Start Quiz</button>
                </div>

                <div id="quiz-container" class="quiz-container" aria-live="polite">
                    <!-- Quiz content will be displayed here -->
                </div>
                
                <div id="quiz-results" class="quiz-results hidden" aria-live="polite">
                    <!-- Quiz results will be displayed here -->
                </div>
            </div>
        </section>

        <!-- AI Lab Section -->
        <section id="ai-lab" class="section" role="tabpanel" aria-labelledby="tab-ai">
            <div class="container">
                <h2>AI Lab</h2>
                <p>Switch between OpenAI Codex and Google Gemini, chat with the AI tutor, spin up flashcards, and let the quiz adapt to you.</p>
                <div class="ai-grid">
                    <div class="ai-card">
                        <h3>‚öôÔ∏è AI Settings</h3>
                        <p>Choose which backend powers tutoring, flashcards, and adaptive quizzes.</p>
                        <label for="ai-provider-select">AI Provider</label>
                        <select id="ai-provider-select" class="provider-select" aria-label="AI provider selector">
                            <option value="openai">OpenAI Codex</option>
                            <option value="gemini">Google Gemini</option>
                        </select>
                        <div class="adaptive-summary">
                            <span class="badge" id="provider-badge">Active: OpenAI Codex</span>
                            <small id="api-key-hint">API keys loaded from ai-config.js</small>
                        </div>
                    </div>

                    <div class="ai-card">
                        <h3>üéì AI Tutor</h3>
                        <div id="ai-tutor-log" class="ai-log" aria-live="polite" aria-label="AI tutor conversation"></div>
                        <label for="ai-tutor-input" class="sr-only">Ask the tutor</label>
                        <textarea id="ai-tutor-input" class="ai-input" placeholder="Ask a physiology question or request an explanation..."></textarea>
                        <div class="adaptive-summary">
                            <button id="ask-ai-btn" class="btn btn--primary">Ask Tutor</button>
                            <span class="badge" id="tutor-status">Ready</span>
                        </div>
                    </div>

                    <div class="ai-card">
                        <h3>üÉè Gemini Flashcards</h3>
                        <p>Create targeted flashcards directly from a lecture.</p>
                        <label for="flashcard-lecture-select">Lecture source</label>
                        <select id="flashcard-lecture-select" class="provider-select"></select>
                        <div class="adaptive-summary">
                            <button id="generate-flashcards-btn" class="btn btn--secondary">Generate Flashcards</button>
                            <span class="badge" id="flashcard-status">Gemini ready</span>
                        </div>
                        <div id="flashcard-output" class="flashcard-grid" aria-live="polite"></div>
                    </div>

                    <div class="ai-card">
                        <h3>üìà Adaptive Quiz Coach</h3>
                        <p>Difficulty adjusts in real time based on your answers and AI insights.</p>
                        <div class="adaptive-summary">
                            <span class="badge" id="current-difficulty">Current level: medium</span>
                            <button id="sync-difficulty-btn" class="btn btn--secondary btn--sm">Sync with AI</button>
                        </div>
                        <ul id="adaptive-notes"></ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- Exam Checklist Section -->
        <section id="checklist" class="section" role="tabpanel" aria-labelledby="tab-checklist">
            <div class="container">
                <h2>Exam Preparation Checklist</h2>
                <div class="checklist-progress">
                    <div class="progress-stats">
                        <div class="stat">
                            <span class="stat-number" id="completed-count">0</span>
                            <span class="stat-label">Completed</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="total-count">0</span>
                            <span class="stat-label">Total Items</span>
                        </div>
                        <div class="stat">
                            <span class="stat-number" id="completion-percentage">0%</span>
                            <span class="stat-label">Complete</span>
                        </div>
                    </div>
                </div>
                
                <div class="checklist-categories">
                    <div class="checklist-category neural">
                        <h3>Neural Function Concepts</h3>
                        <div id="neural-checklist" class="checklist-items"></div>
                    </div>
                    
                    <div class="checklist-category muscle">
                        <h3>Muscle Physiology Concepts</h3>
                        <div id="muscle-checklist" class="checklist-items"></div>
                    </div>
                    
                    <div class="checklist-category sensory">
                        <h3>Sensory Systems Concepts</h3>
                        <div id="sensory-checklist" class="checklist-items"></div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Modal for Lecture Details -->
    <div id="lecture-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <span class="close" id="close-modal-btn" aria-label="Close modal">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <footer class="footer">
      <div class="container">
        <p>&copy; 2025 PHYL2002 Study App. Built to enhance learning.</p>
      </div>
    </footer>

    <script src="ai-config.js"></script>
    <script>
      // =================================================================================
      // DATA
      // =================================================================================
      const lecturesData = [
          { id: 1, title: "Introduction to Neural Function", category: "neural", objectives: ["Define divisions of the nervous system", "Identify neuron components", "Explain graded potentials", "Describe summation and integration"], mechanisms: ["Resting membrane potential (-60 to -70 mV)", "Graded potentials decay with distance", "Spatial and temporal summation", "Action potential threshold at axon hillock"], clinical: "Understanding neural circuits helps explain reflexes and motor control" },
          { id: 2, title: "Ion Channel Function", category: "neural", objectives: ["List three main types of ion channels", "Explain channel selectivity", "Describe voltage gating conformational states", "Give examples of channel roles"], mechanisms: ["Voltage-gated: resting, activated, inactivated states", "Ligand-gated: agonist binding opens channel", "Mechanically-gated: stretch activation", "Selectivity by size and charge"], clinical: "Channel blockers like lidocaine are local anesthetics" },
          { id: 3, title: "Action Potentials I", category: "neural", objectives: ["Explain ionic basis of action potential", "Describe current flows during AP", "Explain unidirectional propagation", "Compare myelinated vs unmyelinated conduction"], mechanisms: ["Na+ influx causes depolarization", "K+ efflux causes repolarization", "Inactivation gates create refractory period", "Saltatory conduction increases speed"], clinical: "AP conduction velocity affects reflex speed" },
          { id: 4, title: "Action Potential Generation II", category: "neural", objectives: ["Explain gap junction function", "Define EPSP and IPSP", "Describe summation of potentials", "Explain stretch reflex pathway"], mechanisms: ["Gap junctions allow electrical coupling", "EPSPs depolarize, IPSPs hyperpolarize", "Integration occurs at axon hillock", "Monosynaptic reflex has minimal delay"], clinical: "Reflexes test neural pathway integrity" },
          { id: 5, title: "Synaptic Transmission", category: "neural", objectives: ["Compare electrical vs chemical synapses", "Describe vesicle release mechanism", "List neurotransmitter categories", "Explain neuromuscular junction"], mechanisms: ["Ca2+ entry triggers SNARE-mediated exocytosis", "Vesicle docking and priming", "Receptor determines response", "ACh activates nicotinic receptors at NMJ"], clinical: "Myasthenia gravis affects ACh receptors" },
          { id: 6, title: "Skeletal Muscle I", category: "muscle", objectives: ["Describe sliding filament theory", "Explain crossbridge cycle", "Describe excitation-contraction coupling", "Define sarcomere structure"], mechanisms: ["Ca2+ binds troponin, moves tropomyosin", "Myosin heads bind actin, power stroke occurs", "DHPR activates RyR channels", "ATP required for crossbridge cycling"], clinical: "Rigor mortis occurs when ATP depleted" },
          { id: 7, title: "Skeletal Muscle II", category: "muscle", objectives: ["Explain length-tension relationship", "Describe force-velocity curve", "Define summation and tetanus", "Compare fiber types"], mechanisms: ["Optimal overlap gives maximum force", "Higher loads reduce shortening velocity", "Frequency coding increases force", "Type I oxidative, Type II glycolytic"], clinical: "Muscle fatigue relates to fiber type recruitment" },
          { id: 8, title: "Cardiac Muscle", category: "muscle", objectives: ["Explain cardiac rhythmicity", "Describe pacemaker potentials", "Compare cardiac vs skeletal muscle", "Explain intercalated disks"], mechanisms: ["SA node generates pacemaker potential", "Funny current (HCN) depolarizes", "Ca2+-induced Ca2+ release from SR", "Gap junctions spread excitation"], clinical: "Heart transplants work without nerve connections" },
          { id: 9, title: "Smooth Muscle", category: "muscle", objectives: ["Distinguish multi-unit vs single-unit", "Explain slow wave generation", "Describe calmodulin-MLCK pathway", "List autonomic effects"], mechanisms: ["ICC generate slow waves", "Ca2+-calmodulin activates MLCK", "Myosin phosphorylation enables binding", "L-type channels provide Ca2+"], clinical: "Smooth muscle controls blood pressure and breathing" },
          { id: 10, title: "Sensory Processing", category: "sensory", objectives: ["Explain sensory transduction principles", "Define labeled line concept", "Describe proprioceptors", "Understand spatial acuity"], mechanisms: ["Stimulus energy ‚Üí receptor potential ‚Üí APs", "Frequency coding for intensity", "Muscle spindles detect length", "Receptive field size affects acuity"], clinical: "Bionic devices exploit labeled lines" },
          { id: 11, title: "Hearing and Balance", category: "sensory", objectives: ["Describe hair cell transduction", "Explain frequency coding", "Understand basilar membrane", "Describe vestibular function"], mechanisms: ["Tip links open mechanosensitive channels", "Tonotopic organization along cochlea", "Outer hair cells amplify response", "Stereocilia deflection direction matters"], clinical: "Hearing loss from hair cell damage" },
          { id: 12, title: "Olfaction and Gustation", category: "sensory", objectives: ["Explain olfactory transduction", "Describe population coding", "List taste modalities", "Understand taste cell types"], mechanisms: ["G-protein (Golf) ‚Üí cAMP ‚Üí channels", "Each odorant activates multiple receptors", "Five basic tastes: sweet, sour, salty, bitter, umami", "Different transduction mechanisms per taste"], clinical: "Anosmia affects taste perception" },
          { id: 13, title: "Vision (Phototransduction)", category: "sensory", objectives: ["Explain phototransduction cascade", "Compare rods vs cones", "Describe color vision", "Understand retinal processing"], mechanisms: ["Light ‚Üí rhodopsin ‚Üí transducin ‚Üí PDE ‚Üí cGMP decrease", "Channel closure causes hyperpolarization", "Three cone types enable color vision", "Center-surround receptive fields"], clinical: "Color blindness from cone mutations" },
          { id: 14, title: "Motor Circuits and Reflexes", category: "sensory", objectives: ["Explain stretch reflex circuit", "Describe Golgi tendon organs", "Define inhibitory interneurons", "Understand gamma motor system"], mechanisms: ["Monosynaptic Ia ‚Üí alpha motor neuron", "GTOs detect muscle tension via Ib fibers", "Reciprocal inhibition via Ia interneurons", "Gamma motor neurons maintain spindle sensitivity"], clinical: "Reflexes test spinal cord function" }
      ];

      const ionChannelsData = [
          { type: "Voltage-gated Na+", states: "Resting, Activated, Inactivated", function: "Action potential depolarization", blockers: "TTX, lidocaine" },
          { type: "Voltage-gated K+", states: "Closed, Open", function: "Repolarization", blockers: "TEA" },
          { type: "Voltage-gated Ca2+", states: "L-type, N-type, P/Q-type", function: "Neurotransmitter release, contraction", blockers: "Nifedipine, œâ-conotoxin" },
          { type: "Ligand-gated", states: "Nicotinic ACh, NMDA, GABA", function: "Synaptic transmission", blockers: "Various antagonists" }
      ];

      const neurotransmittersData = [
          { name: "Acetylcholine (ACh)", location: "NMJ, autonomic ganglia, CNS", receptors: "Nicotinic, Muscarinic", func: "Muscle contraction, autonomic regulation, memory" },
          { name: "Glutamate", location: "Throughout CNS", receptors: "NMDA, AMPA, Kainate", func: "Primary excitatory neurotransmitter, learning, memory" },
          { name: "GABA", location: "Throughout CNS", receptors: "GABA-A, GABA-B", func: "Primary inhibitory neurotransmitter, sedation, anxiety reduction" },
          { name: "Dopamine", location: "Substantia nigra, VTA", receptors: "D1-D5", func: "Motor control, reward, motivation" },
          { name: "Serotonin (5-HT)", location: "Raphe nuclei", receptors: "Multiple 5-HT subtypes", func: "Mood, sleep, appetite regulation" },
          { name: "Noradrenaline", location: "Locus coeruleus", receptors: "Alpha & Beta adrenergic", func: "Arousal, alertness, fight-or-flight response" }
      ];

      const practiceQuestions = [
          { question: "What is the primary cause of the rising phase of an action potential?", options: ["K+ efflux", "Na+ influx", "Ca2+ influx", "Cl- influx"], correct: "Na+ influx", explanation: "The rapid influx of Na+ ions through voltage-gated channels causes the membrane to depolarize, leading to the rising phase of the action potential.", category: "neural", difficulty: "easy" },
          { question: "Which of the following muscle types relies on the calmodulin-MLCK system for contraction?", options: ["Skeletal", "Cardiac", "Smooth", "All of the above"], correct: "Smooth", explanation: "Smooth muscle contraction is initiated by Ca2+ binding to calmodulin, which then activates Myosin Light Chain Kinase (MLCK) to phosphorylate myosin heads.", category: "muscle", difficulty: "easy" },
          { question: "What is the main function of outer hair cells in the cochlea?", options: ["Transmit auditory signals to the brain", "Provide mechanical amplification", "Detect linear acceleration", "Detect rotational movement"], correct: "Provide mechanical amplification", explanation: "Outer hair cells act as cochlear amplifiers, actively changing their length to amplify the motion of the basilar membrane, which enhances hearing sensitivity and frequency selectivity.", category: "sensory", difficulty: "easy" },
          { question: "The absolute refractory period during an action potential is caused by:", options: ["The opening of K+ channels", "The inactivation of Na+ channels", "The closing of Ca2+ channels", "Membrane hyperpolarization"], correct: "The inactivation of Na+ channels", explanation: "The inactivation gates of voltage-gated Na+ channels close during depolarization and do not reopen until the membrane repolarizes, preventing the initiation of another action potential.", category: "neural", difficulty: "medium" },
          { question: "The direct coupling of electrical excitation to Ca2+ release in skeletal muscle is mediated by:", options: ["Troponin and tropomyosin", "The sarcoplasmic reticulum", "The DHPR-RyR complex", "Actin-myosin binding"], correct: "The DHPR-RyR complex", explanation: "The Dihydropyridine Receptor (DHPR) is a voltage sensor that is physically linked to the Ryanodine Receptor (RyR) on the sarcoplasmic reticulum. This mechanical coupling allows for direct, rapid release of Ca2+ upon membrane depolarization.", category: "muscle", difficulty: "medium" },
          { question: "The 'labeled line' principle in sensory systems states that:", options: ["The intensity of a stimulus is coded by action potential frequency", "The brain interprets the modality of a sensation based on which specific pathway is activated", "Sensory adaptation reduces the response to a constant stimulus", "Receptive fields determine spatial acuity"], correct: "The brain interprets the modality of a sensation based on which specific pathway is activated", explanation: "This principle means that a signal from the optic nerve is always perceived as light, regardless of how it was stimulated (e.g., by light or by pressure on the eyeball).", category: "sensory", difficulty: "medium" },
          { question: "Why is myelination especially important for large-diameter axons?", options: ["It enables graded potentials to travel farther", "It reduces the need for voltage-gated channels", "It enables saltatory conduction that preserves speed over long distances", "It increases the number of synaptic vesicles"], correct: "It enables saltatory conduction that preserves speed over long distances", explanation: "Myelin reduces capacitance and increases membrane resistance, allowing action potentials to jump between nodes of Ranvier and maintain rapid conduction in long axons.", category: "neural", difficulty: "hard" },
          { question: "During sustained submaximal exercise, which motor units are recruited first?", options: ["Fast glycolytic units", "Slow oxidative units", "Fast oxidative-glycolytic units", "Random recruitment"], correct: "Slow oxidative units", explanation: "Size principle recruitment activates fatigue-resistant slow oxidative fibers before larger fast units, matching force with metabolic cost.", category: "muscle", difficulty: "hard" },
          { question: "Which vestibular structure primarily detects rotational acceleration?", options: ["Utricle", "Saccule", "Semicircular canals", "Organ of Corti"], correct: "Semicircular canals", explanation: "The semicircular canals contain hair cells that respond to angular acceleration, allowing the brain to track head rotation.", category: "sensory", difficulty: "medium" },
          { question: "How does temporal summation increase muscle tension?", options: ["By recruiting additional muscle fibers", "By increasing action potential amplitude", "By delivering stimuli before Ca2+ fully resequesters, stacking force", "By lengthening the sarcomere"], correct: "By delivering stimuli before Ca2+ fully resequesters, stacking force", explanation: "When stimuli arrive rapidly, Ca2+ remains elevated and crossbridge cycling continues, producing greater force until fused tetanus.", category: "muscle", difficulty: "medium" }
      ];

      const checklistItemsData = {
          neural: ["Resting membrane potential", "Ion channel types and functions", "Action potential phases", "Synaptic transmission", "EPSP and IPSP summation", "Key neurotransmitter roles"],
          muscle: ["Sliding filament theory", "Crossbridge cycling mechanism", "Excitation-contraction coupling", "Comparison of three muscle types", "Length-tension relationship", "Cardiac pacemaker mechanism", "Smooth muscle regulation"],
          sensory: ["Sensory transduction principles", "Labeled line principle", "Hair cell function (hearing/balance)", "Phototransduction cascade (vision)", "Taste and smell mechanisms", "Proprioception (spindles/GTOs)", "Spinal reflex pathways"]
      };

      class AIService {
          constructor(config = {}) {
              this.provider = config.defaultProvider || 'openai';
              this.config = config;
          }

          setProvider(provider) {
              this.provider = provider;
              return this.provider;
          }

          getProvider() {
              return this.provider;
          }

          getApiKey(provider = this.provider) {
              if (provider === 'gemini') {
                  return this.config.GEMINI_API_KEY;
              }
              return this.config.OPENAI_API_KEY;
          }

          async requestCompletion(prompt, options = {}) {
              const provider = options.provider || this.provider;
              const apiKey = this.getApiKey(provider);

              if (!apiKey || apiKey.includes('YOUR_')) {
                  return this.buildFallback(prompt, options.context, 'No API key provided');
              }

              const requestBody = provider === 'gemini'
                  ? { contents: [{ parts: [{ text: prompt }] }] }
                  : { model: 'gpt-4o-mini', messages: [{ role: 'user', content: prompt }], temperature: options.temperature || 0.4 };

              const url = provider === 'gemini'
                  ? `https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${apiKey}`
                  : 'https://api.openai.com/v1/chat/completions';

              const headers = provider === 'gemini'
                  ? { 'Content-Type': 'application/json' }
                  : { 'Content-Type': 'application/json', Authorization: `Bearer ${apiKey}` };

              try {
                  const response = await fetch(url, { method: 'POST', headers, body: JSON.stringify(requestBody) });
                  if (!response.ok) throw new Error('API request failed');
                  const data = await response.json();
                  return this.extractText(data, provider);
              } catch (error) {
                  return this.buildFallback(prompt, options.context, error.message);
              }
          }

          extractText(data, provider) {
              if (provider === 'gemini') {
                  return data.candidates?.[0]?.content?.parts?.[0]?.text || 'Gemini response unavailable.';
              }
              return data.choices?.[0]?.message?.content || 'OpenAI response unavailable.';
          }

          buildFallback(prompt, context = 'general', reason = '') {
              const note = reason ? ` (offline fallback: ${reason})` : ' (offline fallback)';
              if (context === 'flashcards') {
                  return [
                      { front: 'Core idea', back: `Key takeaway: ${prompt.split('.')[0] || 'concept'}${note}` },
                      { front: 'Mechanism', back: 'Explain the sequence of events and the controlling variables.' },
                      { front: 'Clinical angle', back: 'Relate this concept to a lab or bedside scenario.' }
                  ];
              }
              if (context === 'difficulty') {
                  return { level: 'medium', rationale: `Using heuristic difficulty from recent answers${note}` };
              }
              return `Here is a structured explanation based on your prompt${note}: ${prompt.substring(0, 140)}...`;
          }

          async generateTutorResponse(question) {
              const prompt = `You are an expert physiology tutor. Provide a concise, stepwise answer with one vivid analogy. Question: ${question}`;
              return this.requestCompletion(prompt, { context: 'tutor', temperature: 0.6 });
          }

          async generateFlashcards(lecture) {
              const lectureNotes = `Title: ${lecture.title}. Objectives: ${lecture.objectives.join('; ')}. Mechanisms: ${lecture.mechanisms.join('; ')}. Clinical: ${lecture.clinical}.`;
              const prompt = `Create 4 Q&A flashcards from these lecture notes. Use short phrases for the front, and detailed yet concise answers for the back. Return as numbered list.`;
              const raw = await this.requestCompletion(`${prompt} ${lectureNotes}`, { context: 'flashcards', provider: 'gemini' });

              if (Array.isArray(raw)) {
                  return raw;
              }

              return raw.split(/\n+/).filter(Boolean).slice(0, 4).map((line, index) => {
                  const [front, ...rest] = line.replace(/^\d+\.\s*/, '').split(' - ');
                  return { front: front || `Card ${index + 1}`, back: rest.join(' - ') || 'Answer pending' };
              });
          }

          async suggestDifficulty(history, currentLevel) {
              const correctRate = history.length ? history.filter(h => h.isCorrect).length / history.length : 0.5;
              const heuristic = correctRate > 0.75 ? 'hard' : correctRate < 0.45 ? 'easy' : 'medium';
              const prompt = `You are adapting quiz difficulty. Current level: ${currentLevel}. History: ${history.map(h => `${h.isCorrect ? '‚úÖ' : '‚ùå'} ${h.question}`).join(' | ') || 'No answers yet'}. Recommend easy, medium, or hard with one-line rationale.`;
              const raw = await this.requestCompletion(prompt, { context: 'difficulty' });

              if (raw && typeof raw === 'object' && raw.level) {
                  return raw;
              }

              const lower = String(raw).toLowerCase();
              const suggestedLevel = ['easy', 'medium', 'hard'].find(level => lower.includes(level)) || heuristic;
              return { level: suggestedLevel, rationale: typeof raw === 'string' ? raw : `Set to ${heuristic} based on accuracy.` };
          }
      }

      // =================================================================================
      // APPLICATION STATE
      // =================================================================================

      let state = {
          completedLectures: new Set(),
          completedChecklist: new Set(),
          currentTheme: 'light',
          aiProvider: (window.AI_CONFIG && window.AI_CONFIG.defaultProvider) || 'openai',
          tutorMessages: [],
          flashcards: [],
          quiz: {
              active: false,
              questions: [],
              currentIndex: 0,
              answers: [],
              difficulty: 'medium',
              history: []
          }
      };

      const aiService = new AIService(window.AI_CONFIG || {});

      // =================================================================================
      // DOM ELEMENTS
      // =================================================================================

      const elements = {
          navTabs: document.querySelectorAll('.nav-tab'),
          sections: document.querySelectorAll('.section'),
          refTabs: document.querySelectorAll('.ref-tab'),
          refTables: document.querySelectorAll('.reference-table'),
          modal: document.getElementById('lecture-modal'),
          modalBody: document.getElementById('modal-body'),
          closeModalBtn: document.getElementById('close-modal-btn'),
          themeToggleBtn: document.getElementById('theme-toggle'),
          resetProgressBtn: document.getElementById('reset-progress-btn'),
          quizContainer: document.getElementById('quiz-container'),
          quizResults: document.getElementById('quiz-results'),
          topicFilter: document.getElementById('topic-filter'),
          startQuizBtn: document.getElementById('start-quiz-btn'),
          aiProviderSelect: document.getElementById('ai-provider-select'),
          providerBadge: document.getElementById('provider-badge'),
          aiTutorInput: document.getElementById('ai-tutor-input'),
          aiTutorLog: document.getElementById('ai-tutor-log'),
          askAIBtn: document.getElementById('ask-ai-btn'),
          tutorStatus: document.getElementById('tutor-status'),
          flashcardSelect: document.getElementById('flashcard-lecture-select'),
          flashcardBtn: document.getElementById('generate-flashcards-btn'),
          flashcardOutput: document.getElementById('flashcard-output'),
          flashcardStatus: document.getElementById('flashcard-status'),
          currentDifficulty: document.getElementById('current-difficulty'),
          adaptiveNotes: document.getElementById('adaptive-notes'),
          syncDifficultyBtn: document.getElementById('sync-difficulty-btn'),
          adaptiveStatus: document.getElementById('adaptive-status'),
      };

      // =================================================================================
      // INITIALIZATION
      // =================================================================================

      document.addEventListener('DOMContentLoaded', () => {
          loadState();
          initializeEventListeners();
          renderAll();
      });

      function renderAll() {
          renderLectures();
          renderIonChannelTable();
          renderNeurotransmitters();
          renderChecklist();
          renderTopicFilter();
          populateFlashcardLectures();
          hydrateAISettings();
          renderTutorLog();
          renderFlashcards();
          updateAdaptiveUI();
          updateAdaptiveNotes();
          updateProgress();
          applyTheme();
          resetQuizView();
      }

      function initializeEventListeners() {
          elements.navTabs.forEach(tab => tab.addEventListener('click', handleNavClick));
          elements.refTabs.forEach(tab => tab.addEventListener('click', handleRefClick));
          elements.closeModalBtn.addEventListener('click', closeLectureModal);
          elements.modal.addEventListener('click', (e) => { if (e.target === elements.modal) closeLectureModal(); });
          document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeLectureModal(); });
          elements.themeToggleBtn.addEventListener('click', toggleTheme);
          elements.resetProgressBtn.addEventListener('click', resetProgress);
          elements.startQuizBtn.addEventListener('click', startQuiz);
          elements.aiProviderSelect.addEventListener('change', handleProviderChange);
          elements.askAIBtn.addEventListener('click', handleTutorAsk);
          elements.flashcardBtn.addEventListener('click', handleFlashcardGeneration);
          elements.syncDifficultyBtn.addEventListener('click', syncDifficultyWithAI);
          // Keyboard shortcuts for answer selection and next
          document.addEventListener('keydown', handleQuizKeyDown);
      }

      // =================================================================================
      // STATE MANAGEMENT (LOCAL STORAGE)
      // =================================================================================

      function saveState() {
          const appState = {
              completedLectures: [...state.completedLectures],
              completedChecklist: [...state.completedChecklist],
              currentTheme: state.currentTheme,
              aiProvider: state.aiProvider,
              quizDifficulty: state.quiz.difficulty
          };
          localStorage.setItem('phyl2002AppState', JSON.stringify(appState));
      }

      function loadState() {
          const savedState = localStorage.getItem('phyl2002AppState');
          if (savedState) {
              const parsedState = JSON.parse(savedState);
              state.completedLectures = new Set(parsedState.completedLectures);
              state.completedChecklist = new Set(parsedState.completedChecklist);
              state.currentTheme = parsedState.currentTheme || 'light';
              state.aiProvider = parsedState.aiProvider || state.aiProvider;
              state.quiz.difficulty = parsedState.quizDifficulty || state.quiz.difficulty;
          } else {
              // First time load: detect preferred theme
              state.currentTheme = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
          }
      }

      // =================================================================================
      // THEME MANAGEMENT
      // =================================================================================

      function applyTheme() {
          document.documentElement.setAttribute('data-theme', state.currentTheme);
          elements.themeToggleBtn.textContent = state.currentTheme === 'light' ? 'üåô Dark' : '‚òÄÔ∏è Light';
      }

      function toggleTheme() {
          state.currentTheme = state.currentTheme === 'light' ? 'dark' : 'light';
          applyTheme();
          saveState();
      }

      function resetProgress() {
          // Clear local storage and state
          localStorage.removeItem('phyl2002AppState');
          state.completedLectures.clear();
          state.completedChecklist.clear();
          state.tutorMessages = [];
          state.flashcards = [];
          state.quiz = { active: false, questions: [], currentIndex: 0, answers: [], difficulty: 'medium', history: [] };
          renderAll();
      }

      // =================================================================================
      // AI BACKEND + EXPERIENCES
      // =================================================================================

      function hydrateAISettings() {
          aiService.setProvider(state.aiProvider);
          if (elements.aiProviderSelect) {
              elements.aiProviderSelect.value = state.aiProvider;
          }
          updateProviderBadge();
      }

      function updateProviderBadge() {
          const label = state.aiProvider === 'gemini' ? 'Google Gemini' : 'OpenAI Codex';
          elements.providerBadge.textContent = `Active: ${label}`;
          elements.flashcardStatus.textContent = state.aiProvider === 'gemini' ? 'Gemini ready' : 'Using selected provider';
      }

      function handleProviderChange(event) {
          state.aiProvider = event.target.value;
          aiService.setProvider(state.aiProvider);
          updateProviderBadge();
          saveState();
      }

      function renderTutorLog() {
          if (!state.tutorMessages.length) {
              elements.aiTutorLog.innerHTML = '<p class="text-center">Ask the AI tutor anything about cellular physiology.</p>';
              return;
          }

          elements.aiTutorLog.innerHTML = state.tutorMessages.map(msg => `
              <div class="ai-message ${msg.role}">
                  <strong>${msg.role === 'user' ? 'You' : 'AI Tutor'}:</strong> ${msg.content}
              </div>
          `).join('');
      }

      function setTutorStatus(text) {
          elements.tutorStatus.textContent = text;
      }

      async function handleTutorAsk() {
          const question = elements.aiTutorInput.value.trim();
          if (!question) return;

          state.tutorMessages.push({ role: 'user', content: question });
          renderTutorLog();
          setTutorStatus('Thinking...');
          elements.aiTutorInput.value = '';

          try {
              const response = await aiService.generateTutorResponse(question);
              state.tutorMessages.push({ role: 'ai', content: response });
              setTutorStatus(`Answered via ${aiService.getProvider()}`);
          } catch (error) {
              state.tutorMessages.push({ role: 'ai', content: 'The AI tutor is unavailable right now.' });
              setTutorStatus('Offline');
          }

          renderTutorLog();
      }

      function populateFlashcardLectures() {
          if (!elements.flashcardSelect.options.length) {
              lecturesData.forEach(lec => {
                  const option = document.createElement('option');
                  option.value = lec.id;
                  option.textContent = `Lecture ${lec.id}: ${lec.title}`;
                  elements.flashcardSelect.appendChild(option);
              });
          }
      }

      function renderFlashcards() {
          if (!state.flashcards.length) {
              elements.flashcardOutput.innerHTML = '<p class="text-center">Flashcards will appear here.</p>';
              return;
          }

          elements.flashcardOutput.innerHTML = state.flashcards.map(card => `
              <div class="flashcard">
                  <h4>${card.front}</h4>
                  <p>${card.back}</p>
              </div>
          `).join('');
      }

      async function handleFlashcardGeneration() {
          const lectureId = parseInt(elements.flashcardSelect.value, 10);
          const lecture = lecturesData.find(l => l.id === lectureId);
          if (!lecture) return;

          elements.flashcardStatus.textContent = 'Generating...';
          try {
              const cards = await aiService.generateFlashcards(lecture);
              state.flashcards = cards;
              elements.flashcardStatus.textContent = 'Complete';
          } catch (error) {
              state.flashcards = [];
              elements.flashcardStatus.textContent = 'Failed to generate';
          }

          renderFlashcards();
      }

      function updateAdaptiveNotes(text = '') {
          if (!text) {
              elements.adaptiveNotes.innerHTML = '<li>Answer questions to let the AI tune difficulty.</li>';
              return;
          }
          elements.adaptiveNotes.innerHTML = `<li>${text}</li>`;
      }

      function updateAdaptiveUI() {
          const difficultyLabel = state.quiz.difficulty || 'medium';
          elements.currentDifficulty.textContent = `Current level: ${difficultyLabel}`;
          elements.adaptiveStatus.textContent = `AI difficulty: ${difficultyLabel}`;
      }

      async function syncDifficultyWithAI() {
          const suggestion = await aiService.suggestDifficulty(state.quiz.answers, state.quiz.difficulty);
          state.quiz.difficulty = suggestion.level || state.quiz.difficulty;
          updateAdaptiveNotes(suggestion.rationale || 'Difficulty updated.');
          updateAdaptiveUI();
          saveState();
      }

      async function adjustQuizDifficulty() {
          state.quiz.history = [...state.quiz.answers];
          const suggestion = await aiService.suggestDifficulty(state.quiz.history, state.quiz.difficulty);
          state.quiz.difficulty = suggestion.level || state.quiz.difficulty;
          updateAdaptiveNotes(suggestion.rationale || 'Difficulty adjusted.');
          updateAdaptiveUI();
          saveState();
      }

      // =================================================================================
      // NAVIGATION
      // =================================================================================

      function handleNavClick(event) {
          const sectionId = event.target.dataset.section;
          elements.sections.forEach(s => s.classList.toggle('active', s.id === sectionId));
          elements.navTabs.forEach(t => {
              const selected = t.dataset.section === sectionId;
              t.classList.toggle('active', selected);
              t.setAttribute('aria-selected', selected);
          });
      }

      function handleRefClick(event) {
          const refId = event.target.dataset.ref;
          elements.refTables.forEach(table => table.classList.toggle('active', table.id === refId));
          elements.refTabs.forEach(tab => {
              const selected = tab.dataset.ref === refId;
              tab.classList.toggle('active', selected);
              tab.setAttribute('aria-selected', selected);
          });
      }

      // =================================================================================
      // CONTENT RENDERING
      // =================================================================================

      function renderLectures() {
          ['neural', 'muscle', 'sensory'].forEach(category => {
              const container = document.getElementById(`${category}-lectures`);
              container.innerHTML = '';
              lecturesData.filter(lec => lec.category === category).forEach(lecture => {
                  const card = document.createElement('div');
                  card.className = 'lecture-card';
                  card.setAttribute('tabindex', '0');
                  card.setAttribute('role', 'button');
                  card.setAttribute('aria-label', `Lecture ${lecture.id}: ${lecture.title}`);
                  card.onclick = () => showLectureDetails(lecture);
                  card.innerHTML = `
                      <div class="lecture-status ${state.completedLectures.has(lecture.id) ? 'completed' : ''}"></div>
                      <h4>${lecture.title}</h4>
                      <p>Lecture ${lecture.id} ‚Ä¢ ${lecture.category.charAt(0).toUpperCase() + lecture.category.slice(1)}</p>
                  `;
                  container.appendChild(card);
              });
          });
      }

      function renderIonChannelTable() {
          const container = document.getElementById('ion-channel-table');
          const table = document.createElement('table');
          table.className = 'data-table';
          table.innerHTML = `
              <thead><tr><th>Channel Type</th><th>States/Subtypes</th><th>Function</th><th>Blockers</th></tr></thead>
              <tbody>
                  ${ionChannelsData.map(ch => `<tr><td><strong>${ch.type}</strong></td><td>${ch.states}</td><td>${ch.function}</td><td>${ch.blockers}</td></tr>`).join('')}
              </tbody>`;
          container.innerHTML = '';
          container.appendChild(table);
      }

      function renderNeurotransmitters() {
          const container = document.getElementById('neurotransmitter-grid');
          container.innerHTML = neurotransmittersData.map(nt => `
              <div class="nt-card">
                  <h4>${nt.name}</h4>
                  <p><strong>Location:</strong> ${nt.location}</p>
                  <p><strong>Receptors:</strong> ${nt.receptors}</p>
                  <p><strong>Function:</strong> ${nt.func}</p>
              </div>`).join('');
      }

      function renderChecklist() {
          Object.keys(checklistItemsData).forEach(category => {
              const container = document.getElementById(`${category}-checklist`);
              container.innerHTML = '';
              checklistItemsData[category].forEach((itemText, index) => {
                  const itemId = `${category}-${index}`;
                  const isCompleted = state.completedChecklist.has(itemId);
                  const itemEl = document.createElement('div');
                  itemEl.className = `checklist-item ${isCompleted ? 'completed' : ''}`;
                  itemEl.setAttribute('tabindex', '0');
                  itemEl.setAttribute('role', 'checkbox');
                  itemEl.setAttribute('aria-checked', isCompleted);
                  itemEl.onclick = () => toggleChecklistItem(itemId);
                  itemEl.innerHTML = `
                      <div class="checklist-checkbox ${isCompleted ? 'checked' : ''}">${isCompleted ? '‚úì' : ''}</div>
                      <div class="checklist-text">${itemText}</div>`;
                  container.appendChild(itemEl);
              });
          });
      }

      function renderTopicFilter() {
          const categories = [...new Set(lecturesData.map(l => l.category))];
          elements.topicFilter.innerHTML = `<option value="all">All Topics</option>` +
              categories.map(cat => `<option value="${cat}">${cat.charAt(0).toUpperCase() + cat.slice(1)}</option>`).join('');
      }

      // =================================================================================
      // LECTURE MODAL
      // =================================================================================

      function showLectureDetails(lecture) {
          elements.modalBody.innerHTML = `
              <h2 class="modal-title" id="modal-title">${lecture.title}</h2>
              <div class="modal-section"><h4>Learning Objectives</h4><ul class="objective-list">${lecture.objectives.map(o => `<li>${o}</li>`).join('')}</ul></div>
              <div class="modal-section"><h4>Key Mechanisms</h4><ul class="mechanism-list">${lecture.mechanisms.map(m => `<li>${m}</li>`).join('')}</ul></div>
              <div class="modal-section"><h4>Clinical Relevance</h4><div class="clinical-box"><p>${lecture.clinical}</p></div></div>
              <button class="btn btn--primary" id="modal-complete-btn">${state.completedLectures.has(lecture.id) ? 'Mark as Incomplete' : 'Mark as Complete'}</button>`;
          
          document.getElementById('modal-complete-btn').onclick = () => {
              toggleLectureComplete(lecture.id);
              closeLectureModal();
          };
          
          elements.modal.classList.add('active');
      }

      function closeLectureModal() {
          elements.modal.classList.remove('active');
      }

      // =================================================================================
      // PROGRESS & COMPLETION LOGIC
      // =================================================================================

      function toggleLectureComplete(lectureId) {
          if (state.completedLectures.has(lectureId)) {
              state.completedLectures.delete(lectureId);
          } else {
              state.completedLectures.add(lectureId);
          }
          updateAndSave();
      }

      function toggleChecklistItem(itemId) {
          if (state.completedChecklist.has(itemId)) {
              state.completedChecklist.delete(itemId);
          } else {
              state.completedChecklist.add(itemId);
          }
          updateAndSave();
      }

      function updateChecklistStats() {
          const totalItems = Object.values(checklistItemsData).flat().length;
          const completedItems = state.completedChecklist.size;
          const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
          
          document.getElementById('completed-count').textContent = completedItems;
          document.getElementById('total-count').textContent = totalItems;
          document.getElementById('completion-percentage').textContent = `${percentage}%`;
      }

      function updateProgress() {
          const totalLectures = lecturesData.length;
          const totalChecklistItems = Object.values(checklistItemsData).flat().length;
          const totalItems = totalLectures + totalChecklistItems;
          
          const completedItems = state.completedLectures.size + state.completedChecklist.size;
          const percentage = totalItems > 0 ? Math.round((completedItems / totalItems) * 100) : 0;
          
          document.getElementById('overall-progress').style.width = `${percentage}%`;
          document.getElementById('progress-text').textContent = `${percentage}%`;
          document.querySelector('.progress-bar').setAttribute('aria-valuenow', percentage);
          updateChecklistStats();
      }

      function updateAndSave() {
          renderLectures();
          renderChecklist();
          updateProgress();
          saveState();
      }

      // =================================================================================
      // QUIZ LOGIC
      // =================================================================================

      function shuffleArray(array) {
          for (let i = array.length - 1; i > 0; i--) {
              const j = Math.floor(Math.random() * (i + 1));
              [array[i], array[j]] = [array[j], array[i]];
          }
          return array;
      }

      function startQuiz() {
          const filter = elements.topicFilter.value;
          const filterByCategory = filter === 'all'
              ? [...practiceQuestions]
              : practiceQuestions.filter(q => q.category === filter);

          let filteredQuestions = filterByCategory.filter(q => (q.difficulty || 'medium') === state.quiz.difficulty);

          if (!filteredQuestions.length) {
              filteredQuestions = filterByCategory;
          }

          state.quiz = {
              active: true,
              questions: shuffleArray(filteredQuestions),
              currentIndex: 0,
              answers: [],
              difficulty: state.quiz.difficulty,
              history: [],
          };

          elements.quizResults.classList.add('hidden');
          updateAdaptiveUI();
          displayQuestion();
      }

      function displayQuestion() {
          if (state.quiz.currentIndex >= state.quiz.questions.length) {
              showQuizResults();
              return;
          }

          const q = state.quiz.questions[state.quiz.currentIndex];
          const options = shuffleArray([...q.options]);
          const difficulty = q.difficulty || state.quiz.difficulty;

          elements.quizContainer.innerHTML = `
              <div class="question-card">
                  <div class="adaptive-summary">
                      <div class="question-text">
                          Question ${state.quiz.currentIndex + 1} of ${state.quiz.questions.length}: ${q.question}
                      </div>
                      <span class="badge">${difficulty} difficulty</span>
                  </div>
                  <div class="option-list">
                      ${options.map((opt, idx) => `<button class="option-button" data-answer="${opt}" data-index="${idx+1}">${opt}</button>`).join('')}
                  </div>
                  <div id="question-feedback" class="hidden"></div>
                  <div class="question-controls" style="margin-top: 16px;">
                      <button class="btn btn--secondary hidden" id="next-btn">Next Question</button>
                  </div>
              </div>`;
          
          document.querySelectorAll('.option-button').forEach(btn => btn.addEventListener('click', selectAnswer));
      }

      function selectAnswer(event) {
          const selectedAnswer = event.target.dataset.answer;
          const question = state.quiz.questions[state.quiz.currentIndex];
          const isCorrect = selectedAnswer === question.correct;
          
          state.quiz.answers.push({
              question: question.question,
              selected: selectedAnswer,
              correctAnswer: question.correct,
              isCorrect: isCorrect,
              explanation: question.explanation,
              options: [...question.options]
          });
          
          document.querySelectorAll('.option-button').forEach(btn => {
              btn.disabled = true;
              if (btn.dataset.answer === question.correct) {
                  btn.classList.add('correct');
              } else if (btn.dataset.answer === selectedAnswer) {
                  btn.classList.add('incorrect');
              }
          });
          
          const feedback = document.getElementById('question-feedback');
          feedback.innerHTML = `<div class="explanation"><strong>${isCorrect ? 'Correct!' : 'Incorrect.'}</strong> ${question.explanation}</div>`;
          feedback.classList.remove('hidden');

          document.getElementById('next-btn').classList.remove('hidden');
          document.getElementById('next-btn').addEventListener('click', nextQuestion);

          adjustQuizDifficulty();
      }

      function nextQuestion() {
          state.quiz.currentIndex++;
          displayQuestion();
      }

      function showQuizResults() {
          const correctCount = state.quiz.answers.filter(a => a.isCorrect).length;
          const totalCount = state.quiz.questions.length;
          const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
          
          elements.quizContainer.innerHTML = '';
          elements.quizResults.innerHTML = `
              <div class="results-score">${correctCount}/${totalCount} (${percentage}%)</div>
              <p>You answered ${correctCount} out of ${totalCount} questions correctly.</p>
              <div class="results-actions">
                  <button class="btn btn--primary" id="review-answers-btn">Review Answers</button>
                  <button class="btn btn--secondary" id="try-again-btn">Try Again</button>
              </div>`;
          
          elements.quizResults.classList.remove('hidden');
          document.getElementById('review-answers-btn').addEventListener('click', reviewAnswers);
          document.getElementById('try-again-btn').addEventListener('click', startQuiz);
      }

      function reviewAnswers() {
          elements.quizResults.classList.add('hidden');
          elements.quizContainer.innerHTML = state.quiz.answers.map((answer, index) => {
            // Determine the order of options for display
            let displayOptions = [...answer.options];
            return `
            <div class="question-card">
                <div class="question-text">
                    Question ${index + 1}: ${answer.question}
                </div>
                <div class="option-list">
                   ${displayOptions.map(opt => `
                      <button class="option-button" disabled 
                          class="${answer.correctAnswer === opt ? 'correct' : (answer.selected === opt ? 'incorrect' : '')}">
                          ${opt}
                      </button>
                    `).join('')}
                </div>
                <div class="explanation">
                    <strong>Your Answer: ${answer.selected} ${answer.isCorrect ? '‚úÖ' : '‚ùå'}</strong>
                    <p>${answer.explanation}</p>
                </div>
            </div>`
          }).join('') + `<div class="text-center" style="margin-top: 24px;"><button class="btn btn--primary" id="back-to-quiz-btn">Back to Quiz</button></div>`;
          
          document.getElementById('back-to-quiz-btn').addEventListener('click', resetQuizView);
      }

      function resetQuizView() {
          state.quiz.active = false;
          elements.quizContainer.innerHTML = '<p class="text-center">Select a topic and click "Start Quiz" to begin.</p>';
          elements.quizResults.classList.add('hidden');
          updateAdaptiveUI();
      }

      function handleQuizKeyDown(e) {
          // Only handle if quiz is active and there are questions displayed
          if (!state.quiz.active || state.quiz.currentIndex >= state.quiz.questions.length) return;
          // Number keys 1-9 select corresponding option if available
          if (e.key >= '1' && e.key <= '9') {
              const index = parseInt(e.key, 10);
              const optionButtons = document.querySelectorAll('.option-button');
              if (optionButtons[index - 1]) {
                  optionButtons[index - 1].click();
              }
          }
          // Enter to go to next question if next button visible
          if (e.key === 'Enter') {
              const nextBtn = document.getElementById('next-btn');
              if (nextBtn && !nextBtn.classList.contains('hidden')) {
                  nextBtn.click();
              }
          }
      }

    </script>
</body>
</html>